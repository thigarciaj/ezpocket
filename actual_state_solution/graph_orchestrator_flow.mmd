graph TD
    Start([Usu√°rio faz pergunta]) --> IntentValidator[Intent Validator]
    
    IntentValidator --> PlanBuilder[Plan Builder]
    IntentValidator --> H1[History Preferences]
    
    PlanBuilder --> PlanConfirm[Plan Confirm]
    PlanBuilder --> H2[History Preferences]
    
    PlanConfirm -->|Aguarda resposta usu√°rio| Decision{Usu√°rio<br/>confirma?}
    
    %% Ramo SIM (apenas uma seta)
    Decision -->|SIM| Yes[  ]
    Yes --> AnalysisOrchestrator["üîß Analysis Orchestrator<br/>Gera Query SQL"]
    Yes --> H3[History Preferences<br/>Salva Plan Confirm]

    %% Ramo N√ÉO (apenas uma seta)
    Decision -->|N√ÉO| No[  ]
    No --> UserProposed[User Proposed Plan<br/>Aguarda sugest√£o]
    No --> H4[History Preferences<br/>Salva Plan Confirm]
    
    %% Fluxo ap√≥s Analysis Orchestrator: Paralelo para SQL Validator + History
    AnalysisOrchestrator -->SQLValidator["üîç SQL Validator<br/>Valida Query Athena"]
    AnalysisOrchestrator -->H5[History Preferences<br/>Salva Analysis Orchestrator]
    
    %% SQL Validator decide o fluxo baseado na valida√ß√£o
    SQLValidator --> ValidationDecision{Query<br/>v√°lida?}
    
    %% Se query V√ÅLIDA: vai para Athena Executor + History (paralelo)
    ValidationDecision -->|V√ÅLIDA| AthenaExecutor["‚ö° Athena Executor<br/>Executa Query"]
    ValidationDecision -->|V√ÅLIDA| H8[History Preferences<br/>Salva SQL Validator]
    
    %% Se query INV√ÅLIDA: vai para AutoCorrection + History (paralelo)
    ValidationDecision -->|INV√ÅLIDA| AutoCorrection[Auto Correction<br/>Corrige Query SQL]
    ValidationDecision -->|INV√ÅLIDA| H8B[History Preferences<br/>Salva SQL Validator]
    
    %% AutoCorrection corrige e vai para Athena Executor + History (paralelo)
    AutoCorrection --> AthenaExecutor2["‚ö° Athena Executor<br/>Executa Query Corrigida"]
    AutoCorrection --> H9[History Preferences<br/>Salva Auto Correction]
    
    %% Athena Executor vai para Python Runtime + History (paralelo)
    AthenaExecutor --> PythonRuntime["üêç Python Runtime<br/>An√°lise Estat√≠stica Python"]
    AthenaExecutor --> H10[History Preferences<br/>Salva Athena Executor]
    AthenaExecutor2 --> PythonRuntime2["üêç Python Runtime<br/>An√°lise Estat√≠stica Python"]
    AthenaExecutor2 --> H10B[History Preferences<br/>Salva Athena Executor]
    
    %% Python Runtime salva no History
    PythonRuntime --> H11[History Preferences<br/>Salva Python Runtime]
    PythonRuntime2 --> H12[History Preferences<br/>Salva Python Runtime]
    
    UserProposed -->|Sugest√£o recebida| PlanRefiner[Plan Refiner<br/>Refina plano]
    UserProposed --> H6[History Preferences<br/>Salva User Proposed]
    
    PlanRefiner -->|Plano refinado| PlanConfirm
    PlanRefiner --> H7[History Preferences<br/>Salva Plan Refiner]
    
    H1 --> End1([Fim])
    H2 --> End2([Fim])
    H3 --> End3([Fim])
    H4 --> End4([Fim])
    H5 --> End5([Fim])
    H6 --> End6([Fim])
    H7 --> End7([Fim])
    H8 --> End8([Fim])
    H8B --> End8B([Fim])
    H9 --> End9([Fim])
    H10 --> End10([Fim])
    H10B --> End10B([Fim])
    H11 --> End11([Fim])
    H12 --> End12([Fim])

    style IntentValidator fill:#e1f5ff
    style PlanBuilder fill:#e1f5ff
    style PlanConfirm fill:#fff4e1
    style AnalysisOrchestrator fill:#e1ffe1
    style SQLValidator fill:#e1f5e1
    style AutoCorrection fill:#ffe1f5
    style UserProposed fill:#ffe1e1
    style PlanRefiner fill:#ffe8cc
    style Decision fill:#f0e1ff
    style ValidationDecision fill:#f0e1ff
    style Yes fill:#ffffff,stroke:#ffffff
    style No fill:#ffffff,stroke:#ffffff
    style H1 fill:#f5f5f5
    style H2 fill:#f5f5f5
    style H3 fill:#f5f5f5
    style H4 fill:#f5f5f5
    style H5 fill:#f5f5f5
    style H6 fill:#f5f5f5
    style H7 fill:#f5f5f5
    style H8 fill:#f5f5f5
    style H8B fill:#f5f5f5
    style H9 fill:#f5f5f5
    style H10 fill:#f5f5f5
    style H10B fill:#f5f5f5
    style H11 fill:#f5f5f5
    style H12 fill:#f5f5f5
    style AthenaExecutor fill:#e1ffe1
    style AthenaExecutor2 fill:#e1ffe1
    style PythonRuntime fill:#ffe8cc
    style PythonRuntime2 fill:#ffe8cc
