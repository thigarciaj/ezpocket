graph TB
    subgraph Frontend["üñ•Ô∏è FRONTEND"]
        HTML[Dashboard HTML<br/>Socket.IO Client<br/>Vanilla JS]
        CSS[Tailwind CSS<br/>Custom Styles]
        WS_Client[WebSocket Client<br/>Real-time Communication]
    end

    subgraph Backend["‚öôÔ∏è BACKEND - Flask Application"]
        Flask[Flask Server<br/>Python 3.11]
        SocketIO[Flask-SocketIO<br/>WebSocket Server]
        Auth[JWT Authentication<br/>Cookie-based]
        Routes[REST API Endpoints<br/>/api/projects<br/>/api/conversations]
    end

    subgraph Database["üíæ DATABASES"]
        Postgres[(PostgreSQL 15<br/>Projetos & Conversas<br/>order_report)]
        Redis[(Redis<br/>Filas de Jobs<br/>Workers State)]
        Athena[(AWS Athena<br/>Dados em Tempo Real<br/>S3 + Presto SQL)]
    end

    subgraph Orchestration["üé≠ ORQUESTRA√á√ÉO"]
        GraphOrch[Graph Orchestrator<br/>Pipeline Manager<br/>Submit Jobs]
        Queue[Sistema de Filas<br/>Redis Customizado<br/>rpush/blpop]
    end

    subgraph AIAgents["ü§ñ AGENTES COM IA (OpenAI GPT-4o)"]
        Intent[Intent Validator<br/>Valida√ß√£o de Inten√ß√£o]
        Plan[Plan Builder<br/>Gera√ß√£o de Planos]
        Refiner[Plan Refiner<br/>Refinamento]
        Analysis[Analysis Orchestrator<br/>Gera√ß√£o SQL]
        Validator[SQL Validator<br/>Valida√ß√£o com GPT-4o]
        Correction[Auto Correction<br/>Corre√ß√£o SQL]
        Runtime[Python Runtime<br/>An√°lise Estat√≠stica]
        Composer[Response Composer<br/>Formata√ß√£o]
        GraphCompiler[Response Graph Compiler<br/>Gr√°ficos Plotly<br/>Randomiza√ß√£o Inteligente]
    end

    subgraph NonAIAgents["‚ö° AGENTES SEM IA"]
        Executor[Athena Executor<br/>Execu√ß√£o SQL]
        Confirm[Plan Confirm<br/>Confirma√ß√£o Usu√°rio]
        Feedback[User Feedback<br/>Avalia√ß√£o]
        History[History Preferences<br/>Persist√™ncia]
        UserPlan[User Proposed Plan<br/>Sugest√£o Usu√°rio]
        DataSync[Data Sync Agent<br/>Athena ‚Üí PostgreSQL]
    end

    subgraph AI_External["üåê SERVI√áOS EXTERNOS"]
        OpenAI[OpenAI API<br/>GPT-4o<br/>Embeddings]
    end

    subgraph Monitoring["üìä MONITORAMENTO"]
        PM2[PM2 Process Manager<br/>Auto-restart<br/>Logs]
        Logs[Application Logs<br/>Debug Info]
    end

    %% Frontend connections
    HTML --> WS_Client
    WS_Client <-->|WebSocket| SocketIO

    %% Backend connections
    Flask --> SocketIO
    Flask --> Auth
    Flask --> Routes
    Routes -->|CRUD| Postgres
    SocketIO --> GraphOrch

    %% Orchestration connections
    GraphOrch -->|Submit Jobs| Queue
    Queue -->|Store State| Redis
    Queue -->|Dispatch| AIAgents
    Queue -->|Dispatch| NonAIAgents

    %% AI Agents connections
    Intent -->|API Call| OpenAI
    Plan -->|API Call| OpenAI
    Refiner -->|API Call| OpenAI
    Analysis -->|API Call| OpenAI
    Validator -->|API Call| OpenAI
    Correction -->|API Call| OpenAI
    Runtime -->|API Call| OpenAI
    Composer -->|API Call| OpenAI
    GraphCompiler -->|API Call| OpenAI

    %% Non-AI Agents connections
    Executor -->|SQL Query| Athena
    Executor -->|SQL Query| Postgres
    History -->|Save| Postgres
    DataSync -->|Sync Data| Athena
    DataSync -->|Copy to| Postgres

    %% Context flow (novo)
    Postgres -.->|Conversation History| Routes
    Routes -.->|Format Context| GraphOrch
    GraphOrch -.->|Context String| AIAgents

    %% Monitoring
    Flask -.->|Managed by| PM2
    AIAgents -.->|Logs| Logs
    NonAIAgents -.->|Logs| Logs

    %% Styling
    classDef frontend fill:#e1f5ff,stroke:#0066cc
    classDef backend fill:#e1ffe1,stroke:#00cc66
    classDef database fill:#ffe1f5,stroke:#cc0066
    classDef ai fill:#fff4e1,stroke:#ff9900
    classDef nonai fill:#f0e1ff,stroke:#9900cc
    classDef external fill:#ffe8cc,stroke:#ff6600
    classDef monitoring fill:#f5f5f5,stroke:#666666

    class HTML,CSS,WS_Client frontend
    class Flask,SocketIO,Auth,Routes backend
    class Postgres,Redis,Athena database
    class Intent,Plan,Refiner,Analysis,Validator,Correction,Runtime,Composer,GraphCompiler ai
    class Executor,Confirm,Feedback,History,UserPlan,DataSync nonai
    class OpenAI external
    class PM2,Logs monitoring

    %% Legend
    subgraph Legend["üìñ LEGENDA"]
        L1[‚Üí Fluxo principal]
        L2[‚á¢ Comunica√ß√£o via API]
        L3[‚ãØ‚Üí Contexto/Config]
    end

    style Legend fill:#ffffff,stroke:#cccccc
