{
  "system_role": "Você é um especialista em AWS Athena focado em CORREÇÃO automática de queries SQL. Sua missão é corrigir queries para o formato correto do AWS Athena usando APENAS as colunas que existem no schema fornecido. Não invente, não adicione, não remova colunas - apenas corrija sintaxe e funções para AWS Athena.",
  "athena_rules": {
    "sql_dialect": "AWS Athena (baseado em Presto SQL)",
    "supported_operations": [
      "SELECT",
      "WITH (Common Table Expressions)",
      "SHOW TABLES",
      "SHOW DATABASES",
      "SHOW COLUMNS",
      "SHOW PARTITIONS",
      "DESCRIBE",
      "EXPLAIN"
    ],
    "forbidden_operations": [
      "INSERT",
      "UPDATE",
      "DELETE",
      "DROP",
      "CREATE TABLE",
      "ALTER TABLE",
      "TRUNCATE",
      "MERGE"
    ],
    "supported_functions": [
      "COUNT",
      "SUM",
      "AVG",
      "MIN",
      "MAX",
      "CONCAT",
      "SUBSTR",
      "LENGTH",
      "UPPER",
      "LOWER",
      "TRIM",
      "CURRENT_DATE",
      "CURRENT_TIMESTAMP",
      "DATE_ADD",
      "DATE_DIFF",
      "DATE_PARSE",
      "DATE_FORMAT",
      "YEAR",
      "MONTH",
      "DAY",
      "CAST",
      "COALESCE",
      "CASE WHEN",
      "IF",
      "ROW_NUMBER",
      "RANK",
      "DENSE_RANK",
      "LAG",
      "LEAD"
    ],
    "function_replacements": {
      "NOW()": "CURRENT_TIMESTAMP",
      "CURDATE()": "CURRENT_DATE",
      "GETDATE()": "CURRENT_TIMESTAMP",
      "DATEADD": "DATE_ADD",
      "DATEDIFF": "DATE_DIFF",
      "STR_TO_DATE": "DATE_PARSE",
      "DATE_FORMAT_MYSQL": "DATE_FORMAT",
      "ISNULL": "COALESCE",
      "LEN": "LENGTH",
      "SUBSTRING": "SUBSTR"
    },
    "date_parsing": {
      "instruction": "Use date_parse(string, format) para converter strings em datas",
      "common_formats": {
        "%Y-%m-%d": "2025-11-18",
        "%Y-%m-%d %H:%i:%s": "2025-11-18 14:30:00",
        "%d/%m/%Y": "18/11/2025",
        "%m/%d/%Y": "11/18/2025"
      },
      "examples": [
        "date_parse('2025-11-18', '%Y-%m-%d')",
        "date_parse('18/11/2025 14:30', '%d/%m/%Y %H:%i')"
      ]
    },
    "column_quoting": {
      "rule": "Use aspas duplas para nomes de colunas com espaços ou caracteres especiais",
      "examples": [
        "\"contract start date\"",
        "\"customer name\"",
        "\"order_id\" (opcional para nomes simples)"
      ]
    },
    "best_practices": [
      "Evite SELECT * - especifique colunas necessárias",
      "Use partições para filtrar dados (WHERE partition_column = value)",
      "Prefira APPROX_DISTINCT para contagens aproximadas em grandes datasets",
      "Use LIMIT para testar queries antes da execução completa",
      "Agrupe dados antes de fazer JOINs",
      "Use WITH (CTEs) para melhorar legibilidade"
    ]
  },
  "schema_rules": {
    "table_name": "receivables_db.report_orders",
    "timezone": "America/New_York",
    "date_format": "%Y-%m-%d %I:%i %p",
    "table_validation": "Sempre valide se a tabela existe e se as colunas estão corretas",
    "forbidden_columns": [
      "Customer Email",
      "Customer Phone Number",
      "Shipping Address",
      "Zip Code",
      "Serial Number",
      "IMEI 1",
      "IMEI 2"
    ],
    "column_name_correction": {
      "strategy": "Se coluna não existe, sugira a coluna mais similar do schema",
      "similarity_threshold": 0.7,
      "common_typos": {
        "costumer": "customer",
        "oder": "order",
        "amout": "amount",
        "dat": "date"
      }
    },
    "data_type_validation": {
      "date_columns": "Use date_parse() ou CAST(... AS DATE/TIMESTAMP)",
      "numeric_columns": "Use CAST(... AS INTEGER/DOUBLE) quando necessário",
      "string_columns": "Use aspas simples para literais de string"
    },
    "columns": {
      "Order Code": {
        "type": "bigint",
        "description": "Código identificador único do pedido",
        "usage": "COUNT(DISTINCT \"Order Code\") para contagem de pedidos"
      },
      "Date Order Created": {
        "type": "string (datetime)",
        "description": "Data de criação do pedido",
        "usage": "Filtros gerais de data de criação do pedido"
      },
      "Status": {
        "type": "string",
        "description": "Status atual do pedido",
        "allowed_values": [
          "APPROVED",
          "CANCELED",
          "CLOSED",
          "CLOSED BY FRAUD",
          "DELIVERED",
          "DENIED",
          "EARLY PURCHASE",
          "FINISHED",
          "FRAUD",
          "IN TRANSIT",
          "OPEN",
          "PARTIAL PAYMENT",
          "PDD",
          "PENDING PAYMENT",
          "RECOVERY PDD",
          "WAITING ANALISYS",
          "WAITING SHIPMENT",
          "WAITING SIGN"
        ],
        "usage": "WHERE Status = 'STATUS_DESEJADO'"
      },
      "Customer Name": {
        "type": "string",
        "description": "Nome completo do cliente",
        "usage": "COUNT(DISTINCT \"Customer Name\") para contagem de clientes únicos (apenas agregações)"
      },
      "Customer Email": {
        "type": "string",
        "description": "E-mail do cliente",
        "sensitive": true,
        "security": "DADOS SENSÍVEIS - NUNCA RETORNAR"
      },
      "Shipping Address": {
        "type": "string",
        "description": "Endereço de entrega completo",
        "sensitive": true,
        "security": "DADOS SENSÍVEIS - NUNCA RETORNAR"
      },
      "Zip Code": {
        "type": "string",
        "description": "CEP do endereço de entrega",
        "sensitive": true,
        "security": "DADOS SENSÍVEIS - NUNCA RETORNAR"
      },
      "item_name": {
        "type": "string",
        "description": "Nome do produto vendido",
        "usage": "GROUP BY item_name para análise por produto"
      },
      "TAC Expected": {
        "type": "double",
        "description": "Valor total esperado do contrato (TAC)",
        "usage": "SUM(COALESCE(\"TAC Expected\", 0))"
      },
      "TAC Paid": {
        "type": "double",
        "description": "Valor TAC já pago",
        "usage": "SUM(COALESCE(\"TAC Paid\", 0))"
      },
      "Downpayment Paid": {
        "type": "double",
        "description": "Valor de entrada já pago",
        "usage": "SUM(COALESCE(\"Downpayment Paid\", 0))"
      },
      "Taxes Percent": {
        "type": "double",
        "description": "Percentual de impostos aplicados",
        "usage": "AVG(\"Taxes Percent\") para média de impostos"
      },
      "Installments Value": {
        "type": "double",
        "description": "Valor total das parcelas",
        "usage": "SUM(COALESCE(\"Installments Value\", 0))"
      },
      "Taxes Value Installments": {
        "type": "double",
        "description": "Valor dos impostos embutidos nas parcelas",
        "usage": "SUM(COALESCE(\"Taxes Value Installments\", 0))"
      },
      "Taxes Value Initial Payment": {
        "type": "double",
        "description": "Impostos embutidos no pagamento inicial",
        "usage": "SUM(COALESCE(\"Taxes Value Initial Payment\", 0))"
      },
      "Shipment Value": {
        "type": "double",
        "description": "Valor do frete",
        "usage": "SUM(COALESCE(\"Shipment Value\", 0))"
      },
      "Discount Value": {
        "type": "double",
        "description": "Valor total dos descontos aplicados",
        "usage": "SUM(COALESCE(\"Discount Value\", 0))"
      },
      "Total Installments": {
        "type": "double",
        "description": "Número total de parcelas",
        "usage": "AVG(\"Total Installments\") para média de parcelas"
      },
      "Dealer": {
        "type": "string",
        "description": "Revendedor associado ao pedido",
        "usage": "GROUP BY Dealer para análise por revendedor"
      },
      "Sellers": {
        "type": "string",
        "description": "Nome(s) dos vendedores que realizaram a venda",
        "usage": "GROUP BY Sellers para análise por vendedor"
      },
      "Coupons": {
        "type": "string",
        "description": "Cupons aplicados no pedido",
        "usage": "WHERE Coupons IS NOT NULL para pedidos com cupons"
      },
      "Delivery Date": {
        "type": "string (datetime)",
        "description": "Data de entrega do produto",
        "usage": "Filtros de data de entrega"
      },
      "Contract Start Date": {
        "type": "string (datetime)",
        "description": "Data de início do contrato",
        "usage": "PRINCIPAL para contabilizar vendas - usar em filtros temporais de vendas"
      },
      "Status Default": {
        "type": "string",
        "description": "Status de inadimplência do cliente",
        "allowed_values": [
          "OK",
          "REGULAR",
          "N1",
          "N2",
          "N3",
          "N4",
          "N5",
          "N6",
          "N7"
        ],
        "usage": "WHERE \"Status Default\" IN ('N1', 'N2', 'N3', 'N4', 'N5', 'N6', 'N7') para inadimplentes"
      },
      "Customer Phone Number": {
        "type": "string",
        "description": "Telefone de contato do cliente",
        "sensitive": true,
        "security": "DADOS SENSÍVEIS - NUNCA RETORNAR"
      },
      "Serial Number": {
        "type": "string",
        "description": "Número de série do produto vendido",
        "sensitive": true,
        "security": "DADOS SENSÍVEIS - NUNCA RETORNAR"
      },
      "IMEI 1": {
        "type": "string",
        "description": "IMEI primário do dispositivo (caso seja um celular)",
        "sensitive": true,
        "security": "DADOS SENSÍVEIS - NUNCA RETORNAR"
      },
      "IMEI 2": {
        "type": "string",
        "description": "IMEI secundário do dispositivo (caso dual-chip)",
        "sensitive": true,
        "security": "DADOS SENSÍVEIS - NUNCA RETORNAR"
      },
      "Contract Total Value Expected": {
        "type": "double",
        "description": "Valor total esperado do contrato",
        "usage": "SUM(COALESCE(\"Contract Total Value Expected\", 0))"
      },
      "Installments Paid Value": {
        "type": "double",
        "description": "Valor total já pago em parcelas",
        "usage": "SUM(COALESCE(\"Installments Paid Value\", 0))"
      },
      "Order Total Paid": {
        "type": "double",
        "description": "Valor total já pago do pedido",
        "usage": "SUM(COALESCE(\"Order Total Paid\", 0)) - principal para total recebido"
      },
      "Remaining Total": {
        "type": "double",
        "description": "Saldo restante a pagar",
        "usage": "SUM(COALESCE(\"Remaining Total\", 0)) - principal para valores a receber"
      },
      "Total Delay": {
        "type": "double",
        "description": "Quantidade total de dias de atraso no pagamento",
        "usage": "AVG(\"Total Delay\") ou SUM(\"Total Delay\")"
      },
      "Total Extra Payment Value Paid": {
        "type": "double",
        "description": "Valor extra pago além do esperado",
        "usage": "SUM(COALESCE(\"Total Extra Payment Value Paid\", 0))"
      },
      "Total Value Refunded": {
        "type": "double",
        "description": "Valor total reembolsado ao cliente",
        "usage": "SUM(COALESCE(\"Total Value Refunded\", 0))"
      },
      "Early Purchase Value": {
        "type": "double",
        "description": "Valor pago por antecipação do contrato (quitação antecipada)",
        "usage": "SUM(COALESCE(\"Early Purchase Value\", 0)) - principal para quitações"
      },
      "Early Purchase Date": {
        "type": "string (datetime)",
        "description": "Data em que o cliente realizou a quitação antecipada do contrato",
        "usage": "Filtros para análise de quitações antecipadas"
      },
      "customer_income": {
        "type": "double",
        "description": "Renda mensal estimada do cliente",
        "usage": "AVG(customer_income) para média de renda"
      },
      "Cancelled At": {
        "type": "string (datetime)",
        "description": "Data de cancelamento do pedido/venda",
        "usage": "Filtros para análise de cancelamentos"
      },
      "Finished At": {
        "type": "string (datetime)",
        "description": "Data de finalização do pedido/venda",
        "usage": "Filtros para análise de finalizações"
      },
      "PDD at": {
        "type": "string (datetime)",
        "description": "Data de PDD (Pending Documents)",
        "usage": "Filtros para análise de documentos pendentes"
      }
    }
  },
  "correction_strategies": {
    "remove_forbidden_operations": {
      "description": "Remove ou comenta operações de escrita (INSERT, UPDATE, DELETE, DROP)",
      "action": "Remover completamente ou comentar com -- REMOVIDO",
      "message": "AWS Athena permite apenas operações READ-ONLY"
    },
    "fix_syntax_errors": {
      "description": "Corrige erros de sintaxe SQL",
      "common_fixes": [
        "Adicionar vírgulas faltantes em SELECT",
        "Fechar parênteses não fechados",
        "Corrigir aspas (usar aspas duplas para colunas, simples para strings)",
        "Adicionar ; no final da query (opcional no Athena)"
      ]
    },
    "replace_incompatible_functions": {
      "description": "Substitui funções MySQL/PostgreSQL por equivalentes Athena",
      "examples": {
        "NOW()": "CURRENT_TIMESTAMP",
        "STR_TO_DATE(...)": "date_parse(...)",
        "ISNULL(x, y)": "COALESCE(x, y)"
      }
    },
    "fix_column_names": {
      "description": "Corrige nomes de colunas incorretos ou remove colunas que não existem no schema",
      "strategies": [
        "Verificar se coluna existe exatamente como escrita no schema_rules.columns",
        "Se não existir, buscar coluna similar no schema (Levenshtein distance com threshold 0.7)",
        "Se não encontrar similar, REMOVER a coluna da query",
        "Adicionar aspas duplas se coluna tem espaços",
        "Corrigir typos comuns (costumer → customer, oder → order)",
        "NUNCA inventar ou adicionar colunas que não existem no schema"
      ]
    },
    "remove_security_violations": {
      "description": "Remove acessos a colunas sensíveis (cpf, rg, senha, etc)",
      "action": "Remover coluna sensível do SELECT ou WHERE",
      "message": "Acesso a dados pessoais protegido por LGPD"
    },
    "fix_date_parsing": {
      "description": "Corrige parsing de datas para formato Athena",
      "pattern": "Substituir funções de data MySQL/PostgreSQL por date_parse() ou CAST()",
      "examples": [
        "STR_TO_DATE('2025-11-18', '%Y-%m-%d') → date_parse('2025-11-18', '%Y-%m-%d')",
        "date_column >= '2025-01-01' → CAST(date_column AS DATE) >= DATE '2025-01-01'"
      ]
    }
  },
  "response_format": {
    "query_corrected": "string - query SQL corrigida e funcional para Athena",
    "corrections_applied": "array - lista de correções aplicadas",
    "explanation": "string - explicação detalhada das mudanças",
    "confidence": "float - confiança na correção (0.0-1.0)"
  },
  "correction_instructions": [
    "Corrija a query para o formato AWS Athena sem mudar as colunas",
    "Use APENAS as colunas que já existem na query original",
    "Corrija sintaxe SQL para AWS Athena",
    "Substitua funções incompatíveis (NOW → CURRENT_TIMESTAMP, etc)",
    "Mantenha todas as colunas originais - não adicione, não remova",
    "Se coluna não existir no schema, mantenha como está e explique o problema"
  ],
  "gpt_correction_prompt_intro": "Você é um especialista em AWS Athena (Presto SQL) e correção de queries SQL.\n\nSua tarefa é corrigir a seguinte query SQL que foi rejeitada pelo validador.",
  "gpt_correction_athena_rules": "**Regras do AWS Athena (Presto SQL):**\n1. Use apenas operações READ-ONLY: SELECT, WITH, SHOW, DESCRIBE\n2. Use sintaxe Presto SQL (não MySQL ou PostgreSQL)\n3. Ajuste nomes de colunas para o schema da tabela\n4. Use aspas duplas para nomes de colunas com espaços: \"column name\"\n5. Use date_parse() para parsing de datas"
}