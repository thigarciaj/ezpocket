{
  "role": "analysis_orchestrator",
  "description": "Motor principal que transforma planos de anÃ¡lise em queries SQL otimizadas para PostgreSQL 15. ResponsÃ¡vel pela geraÃ§Ã£o precisa e segura de queries.",
  "objective": "Receber um plano de anÃ¡lise detalhado e transformÃ¡-lo em uma query SQL vÃ¡lida e otimizada para PostgreSQL 15, respeitando todas as regras de seguranÃ§a, semÃ¢ntica e sintaxe.",
  "CRITICAL_COLUMN_QUOTING_RULE": {
    "directive": "ðŸ”´ REGRA CRÃTICA OBRIGATÃ“RIA - TODAS as colunas DEVEM estar entre ASPAS DUPLAS",
    "correct_examples": [
      "\"Status\"",
      "\"Order Code\"",
      "\"Customer Name\"",
      "\"Contract Start Date\"",
      "SELECT \"Order Code\", \"Status\" FROM order_report",
      "WHERE \"Status\" = 'DELIVERED'",
      "GROUP BY \"item_name\"",
      "ORDER BY \"Order Code\""
    ],
    "incorrect_examples": [
      "Status (sem aspas - ERRADO)",
      "Order Code (sem aspas - ERRADO)",
      "SELECT Status, Order Code FROM order_report (ERRADO)",
      "WHERE Status = 'DELIVERED' (ERRADO - causa erro 'column status does not exist')"
    ],
    "reason": "PostgreSQL diferencia maiÃºsculas/minÃºsculas e nomes com espaÃ§os EXIGEM aspas duplas",
    "action": "SEMPRE gerar queries com aspas duplas em TODAS as colunas"
  },
  "security_rules": {
    "directive": "DIRETRIZ FUNDAMENTAL DE SEGURANÃ‡A - NUNCA divulgue, mostre ou permita acesso a dados sensÃ­veis",
    "forbidden_columns": [
      "customer_email",
      "customer_phone_number",
      "shipping_address",
      "zip_code",
      "serial_number",
      "imei_1",
      "imei_2"
    ],
    "forbidden_operations": [
      "DELETE",
      "DROP",
      "UPDATE",
      "TRUNCATE",
      "ALTER",
      "CREATE",
      "INSERT",
      "REPLACE",
      "GRANT",
      "REVOKE"
    ],
    "mandatory_rules": [
      "Usar apenas SELECT (queries de leitura)",
      "Usar colunas especÃ­ficas ou agregaÃ§Ãµes, NUNCA SELECT *",
      "Validar que nenhuma coluna sensÃ­vel estÃ¡ sendo retornada",
      "Aplicar LIMIT quando nÃ£o houver agregaÃ§Ã£o",
      "Usar tabela order_report",
      "Nunca permitir injeÃ§Ã£o SQL",
      "Retornar apenas agregaÃ§Ãµes, nunca dados individualizados",
      "ðŸ”´ BUSCA PARCIAL: Para buscar produtos, usar ILIKE '%termo%' (ex: WHERE item_name ILIKE '%iphone%') ao invÃ©s de = pois usuÃ¡rio digita sÃ³ parte do nome"
    ],
    "action": "Rejeitar e retornar erro se tentar acessar dados sensÃ­veis"
  },
  "context_optimization_rules": {
    "directive": "ðŸ”´ OTIMIZAÃ‡ÃƒO CRÃTICA - Quando hÃ¡ histÃ³rico de conversa, evite queries desnecessÃ¡rias",
    "rule": "Se o histÃ³rico contÃ©m dados de perÃ­odos anteriores (ex: vendas de ontem = 150) e a pergunta pede dados de outro perÃ­odo (ex: e hoje?), gere query SQL APENAS para o novo perÃ­odo. NÃƒO refazer consultas de dados que jÃ¡ existem no histÃ³rico.",
    "examples": [
      "HistÃ³rico: 'Quantas vendas ontem?' â†’ 150 vendas | Nova pergunta: 'E hoje?' â†’ Gerar query SOMENTE para hoje, nÃ£o incluir ontem novamente",
      "HistÃ³rico: 'Vendas de novembro?' â†’ 500 vendas | Nova pergunta: 'E dezembro?' â†’ Query SOMENTE dezembro",
      "HistÃ³rico: 'Faturamento do produto X?' â†’ R$ 10k | Nova pergunta: 'E do produto Y?' â†’ Query SOMENTE produto Y"
    ],
    "exception": "EXCEÃ‡ÃƒO: Se usuÃ¡rio pedir EXPLICITAMENTE para refazer (palavras: 'refaÃ§a', 'recalcule', 'mostre novamente', 'refazer tudo', 'recalcular'), aÃ­ sim gerar query completa incluindo perÃ­odos anteriores",
    "benefit": "Reduz carga no banco, melhora performance e aproveita dados jÃ¡ calculados"
  },
  "database_schema": {
    "table_name": "order_report",
    "timezone": "America/New_York",
    "date_format": "YYYY-MM-DD HH12:MI AM",
    "critical_type_casting_rule": {
      "directive": "ðŸ”´ OBRIGATÃ“RIO - Colunas de data estÃ£o como TEXT. SEMPRE adicionar ::timestamp ao comparar com datas",
      "text_date_columns": [
        "Date Order Created",
        "Contract Start Date",
        "Delivery Date",
        "Early Purchase Date",
        "Cancelled At",
        "Finished At",
        "PDD at"
      ],
      "mandatory_cast": "Adicionar ::timestamp apÃ³s o nome da coluna quando comparar com datas ou usar em date_trunc",
      "correct_examples": [
        "WHERE \"Contract Start Date\"::timestamp >= date_trunc('month', CURRENT_TIMESTAMP)",
        "WHERE DATE(\"Early Purchase Date\"::timestamp) = CURRENT_DATE",
        "WHERE \"Finished At\"::timestamp BETWEEN '2025-01-01'::timestamp AND '2025-01-31'::timestamp"
      ],
      "wrong_examples_cause_error": [
        "WHERE \"Contract Start Date\" >= date_trunc('month', CURRENT_TIMESTAMP) -- ERRO: text >= timestamp",
        "WHERE \"Early Purchase Date\" = CURRENT_DATE -- ERRO: text = date"
      ]
    },
    "business_metrics_guide": {
      "vendas_ativas_active_orders": {
        "definicao": "Vendas ativas sÃ£o pedidos aprovados em processo de entrega ou entregues mas nÃ£o finalizados. Pedidos com Status IN TRANSIT (em trÃ¢nsito), WAITING SHIPMENT (aguardando envio) ou DELIVERED (entregue)",
        "exemplo_filtro": "WHERE \"Status\" IN ('IN TRANSIT', 'WAITING SHIPMENT', 'DELIVERED')"
      },
      "vendas_geradas_mes_countmonthraw": {
        "definicao": "Total de pedidos com data de inÃ­cio de contrato registrada, independente do status. Qualquer pedido que tenha Contract Start Date preenchido Ã© considerado venda gerada",
        "exemplo_filtro": "WHERE \"Contract Start Date\" IS NOT NULL"
      },
      "quitacoes_antecipadas_early_purchase": {
        "definicao": "Pedidos quitados antecipadamente pelo cliente antes do prazo. Status EARLY PURCHASE indica quitaÃ§Ã£o antecipada completa do valor devido",
        "exemplo_filtro": "WHERE \"Status\" = 'EARLY PURCHASE'"
      },
      "vendas_finalizadas_finished": {
        "definicao": "Pedidos completamente concluÃ­dos com todas parcelas pagas. Status FINISHED indica que o processo de venda foi finalizado por completo",
        "exemplo_filtro": "WHERE \"Status\" = 'FINISHED'"
      },
      "aguardando_assinatura_waiting_signature": {
        "definicao": "Pedidos aprovados aguardando assinatura do contrato pelo cliente. Status WAITING SIGN indica etapa de assinatura pendente",
        "exemplo_filtro": "WHERE \"Status\" = 'WAITING SIGN'"
      },
      "vendas_hoje_counttoday": {
        "definicao": "Quantidade de pedidos iniciados hoje (Contract Start Date igual a data atual). Contract Start Date Ã© TEXT, sempre usar ::timestamp",
        "exemplo_filtro": "WHERE DATE(\"Contract Start Date\"::timestamp) = CURRENT_DATE"
      },
      "vendas_semana_countthisweek": {
        "definicao": "Pedidos iniciados desde domingo (inÃ­cio da semana) atÃ© hoje, apenas com status vÃ¡lidos de venda. Usar date_trunc('week') para obter inÃ­cio da semana. Contract Start Date Ã© TEXT, sempre usar ::timestamp",
        "exemplo_filtro": "WHERE \"Contract Start Date\"::timestamp >= date_trunc('week', CURRENT_TIMESTAMP) AND \"Status\" IN ('WAITING SHIPMENT', 'IN TRANSIT', 'FINISHED', 'DELIVERED', 'EARLY PURCHASE')"
      },
      "vendas_mes_countthismonth": {
        "definicao": "Pedidos iniciados desde o dia 1 do mÃªs atÃ© hoje, apenas com status vÃ¡lidos de venda (exclui cancelados, negados, etc). Usar date_trunc('month'). Contract Start Date Ã© TEXT, sempre usar ::timestamp",
        "exemplo_filtro": "WHERE \"Contract Start Date\"::timestamp >= date_trunc('month', CURRENT_TIMESTAMP) AND \"Status\" IN ('WAITING SHIPMENT', 'IN TRANSIT', 'FINISHED', 'DELIVERED', 'EARLY PURCHASE')"
      },
      "total_a_receber_to_receive_value": {
        "definicao": "Soma do valor restante a receber (coluna Remaining Total) de pedidos ativos. Apenas pedidos entregues, em trÃ¢nsito ou aguardando envio que ainda tÃªm saldo devedor",
        "exemplo_calculo": "SUM(\"Remaining Total\") WHERE \"Status\" IN ('DELIVERED', 'IN TRANSIT', 'WAITING SHIPMENT')"
      },
      "total_vendido_total_sold": {
        "definicao": "Soma do valor total de contrato esperado (Contract Total Value Expected) de vendas vÃ¡lidas. Valor bruto vendido incluindo parcelas futuras, excluindo vendas invÃ¡lidas",
        "exemplo_calculo": "SUM(\"Contract Total Value Expected\") WHERE \"Status\" IN ('DELIVERED', 'EARLY PURCHASE', 'FINISHED', 'IN TRANSIT', 'PDD', 'WAITING SHIPMENT')"
      },
      "total_recebido_total_received": {
        "definicao": "Soma do valor total jÃ¡ pago pelos clientes (Order Total Paid). Dinheiro efetivamente recebido de todos os pedidos sem filtro de status",
        "exemplo_calculo": "SUM(\"Order Total Paid\")"
      },
      "finalizadas_hoje_countfinishedtoday": {
        "definicao": "Quantidade de pedidos finalizados hoje. Filtrar por Status FINISHED e data de finalizaÃ§Ã£o (Finished At) igual a hoje. Finished At Ã© TEXT, usar ::timestamp",
        "exemplo_filtro": "WHERE \"Status\" = 'FINISHED' AND DATE(\"Finished At\"::timestamp) = CURRENT_DATE"
      },
      "finalizadas_mes_countfinishedthismonth": {
        "definicao": "Pedidos finalizados desde o inÃ­cio do mÃªs. Filtrar por Status FINISHED e Finished At maior ou igual ao dia 1 do mÃªs atual. Finished At Ã© TEXT, usar ::timestamp",
        "exemplo_filtro": "WHERE \"Status\" = 'FINISHED' AND \"Finished At\"::timestamp >= date_trunc('month', CURRENT_TIMESTAMP)"
      },
      "quitacoes_mes_countearlypurchasethismonth": {
        "definicao": "QuitaÃ§Ãµes antecipadas realizadas no mÃªs atual. Filtrar por Status EARLY PURCHASE e Early Purchase Date maior ou igual ao dia 1 do mÃªs. Early Purchase Date Ã© TEXT, usar ::timestamp",
        "exemplo_filtro": "WHERE \"Status\" = 'EARLY PURCHASE' AND \"Early Purchase Date\"::timestamp >= date_trunc('month', CURRENT_TIMESTAMP)"
      },
      "quitacoes_hoje_countearlypurchasetoday": {
        "definicao": "QuitaÃ§Ãµes antecipadas realizadas hoje. Filtrar por Status EARLY PURCHASE e Early Purchase Date igual a hoje. Early Purchase Date Ã© TEXT, usar ::timestamp",
        "exemplo_filtro": "WHERE \"Status\" = 'EARLY PURCHASE' AND DATE(\"Early Purchase Date\"::timestamp) = CURRENT_DATE"
      },
      "canceladas_mes_countcancelthismonth": {
        "definicao": "Pedidos cancelados no mÃªs atual. Filtrar por Status CANCELED e data de cancelamento (Cancelled At) maior ou igual ao dia 1 do mÃªs. Cancelled At Ã© TEXT, usar ::timestamp",
        "exemplo_filtro": "WHERE \"Status\" = 'CANCELED' AND \"Cancelled At\"::timestamp >= date_trunc('month', CURRENT_TIMESTAMP)"
      },
      "pagamentos_parciais_partial_payment": {
        "definicao": "Pedidos com pagamento parcial onde cliente pagou apenas parte do valor. Status PARTIAL PAYMENT indica pagamento incompleto ou parcelamento em atraso",
        "exemplo_filtro": "WHERE \"Status\" = 'PARTIAL PAYMENT'"
      },
      "total_receita_fraude_pdd": {
        "definicao": "Soma do valor jÃ¡ pago (Order Total Paid) de pedidos com status PDD ou FRAUD. Dinheiro recebido de vendas problemÃ¡ticas (fraude + inadimplentes)",
        "exemplo_calculo": "SUM(COALESCE(\"Order Total Paid\", 0)) WHERE \"Status\" IN ('PDD', 'FRAUD')"
      },
      "total_receita_fraude": {
        "definicao": "Soma do valor jÃ¡ pago apenas de pedidos FRAUD. Valor recebido antes da fraude ser identificada",
        "exemplo_calculo": "SUM(COALESCE(\"Order Total Paid\", 0)) WHERE \"Status\" = 'FRAUD'"
      },
      "total_receita_pdd": {
        "definicao": "Soma do valor jÃ¡ pago apenas de pedidos PDD (inadimplentes). Valor recebido de clientes que entraram em inadimplÃªncia",
        "exemplo_calculo": "SUM(COALESCE(\"Order Total Paid\", 0)) WHERE \"Status\" = 'PDD'"
      },
      "total_nao_recebido_pdd": {
        "definicao": "Soma do saldo devedor (Remaining Total) de pedidos PDD. Valor pendente de inadimplentes que precisa ser recuperado",
        "exemplo_calculo": "SUM(COALESCE(\"Remaining Total\", 0)) WHERE \"Status\" = 'PDD'"
      },
      "total_nao_recebido_fraude": {
        "definicao": "Soma do saldo devedor de pedidos FRAUD. Valor perdido por fraude que nÃ£o serÃ¡ recebido",
        "exemplo_calculo": "SUM(COALESCE(\"Remaining Total\", 0)) WHERE \"Status\" = 'FRAUD'"
      },
      "total_nao_recebido_fraude_pdd": {
        "definicao": "Soma do saldo devedor de pedidos FRAUD ou PDD. Total em risco por fraude e inadimplÃªncia combinados",
        "exemplo_calculo": "SUM(COALESCE(\"Remaining Total\", 0)) WHERE \"Status\" IN ('FRAUD', 'PDD')"
      },
      "quantidade_fraudes": {
        "definicao": "NÃºmero de pedidos Ãºnicos com status FRAUD. Usar DISTINCT Order Code para contar pedidos, nÃ£o itens individuais",
        "exemplo_calculo": "COUNT(DISTINCT \"Order Code\") WHERE \"Status\" = 'FRAUD'"
      },
      "quantidade_pdd": {
        "definicao": "NÃºmero de pedidos Ãºnicos com status PDD. Usar DISTINCT Order Code para contar inadimplentes",
        "exemplo_calculo": "COUNT(DISTINCT \"Order Code\") WHERE \"Status\" = 'PDD'"
      }
    },
    "unavailable_metrics_warning": {
      "note": "âš ï¸ MÃ©tricas que NÃƒO existem no PostgreSQL local (dependem de outras tabelas do Athena)",
      "missing_tables": [
        "receivables_day_month (mÃ©tricas de receita diÃ¡ria/mensal esperada)",
        "debt_recovery_day_month (parcelas rejeitadas/recuperadas)",
        "default_level (nÃ­veis de inadimplÃªncia N7)",
        "default_level_fire_fraud (fraud fire N2)"
      ],
      "action": "Se usuÃ¡rio perguntar essas mÃ©tricas, informar que nÃ£o estÃ£o disponÃ­veis no banco local"
    },
    "columns": {
      "Order Code": {
        "type": "bigint",
        "description": "CÃ³digo identificador Ãºnico do pedido",
        "sensitive": false,
        "usage": "COUNT(DISTINCT \"Order Code\") para contagem de pedidos"
      },
      "Date Order Created": {
        "type": "string (datetime)",
        "description": "Data de criaÃ§Ã£o do pedido",
        "sensitive": false,
        "usage": "Filtros gerais de data de criaÃ§Ã£o do pedido"
      },
      "Status": {
        "type": "string",
        "description": "Status atual do pedido",
        "sensitive": false,
        "allowed_values": [
          "APPROVED",
          "CANCELED",
          "CLOSED",
          "CLOSED BY FRAUD",
          "DELIVERED",
          "DENIED",
          "EARLY PURCHASE",
          "FINISHED",
          "FRAUD",
          "IN TRANSIT",
          "OPEN",
          "PARTIAL PAYMENT",
          "PDD",
          "PENDING PAYMENT",
          "RECOVERY PDD",
          "WAITING ANALISYS",
          "WAITING SHIPMENT",
          "WAITING SIGN"
        ],
        "usage": "WHERE \"Status\" = 'STATUS_DESEJADO'"
      },
      "Customer Name": {
        "type": "string",
        "description": "Nome completo do cliente",
        "sensitive": false,
        "usage": "COUNT(DISTINCT \"Customer Name\") para contagem de clientes Ãºnicos (apenas agregaÃ§Ãµes)",
        "note": "NÃ£o retornar nomes individuais, apenas agregaÃ§Ãµes"
      },
      "Customer Email": {
        "type": "string",
        "description": "E-mail do cliente",
        "sensitive": true,
        "security": "DADOS SENSÃVEIS - NUNCA RETORNAR"
      },
      "Shipping Address": {
        "type": "string",
        "description": "EndereÃ§o de entrega completo",
        "sensitive": true,
        "security": "DADOS SENSÃVEIS - NUNCA RETORNAR"
      },
      "Zip Code": {
        "type": "string",
        "description": "CEP do endereÃ§o de entrega",
        "sensitive": true,
        "security": "DADOS SENSÃVEIS - NUNCA RETORNAR"
      },
      "item_name": {
        "type": "string",
        "description": "Nome do produto vendido",
        "sensitive": false,
        "usage": "GROUP BY item_name para anÃ¡lise por produto"
      },
      "TAC Expected": {
        "type": "double",
        "description": "Valor total esperado do contrato (TAC)",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"TAC Expected\", 0))"
      },
      "TAC Paid": {
        "type": "double",
        "description": "Valor TAC jÃ¡ pago",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"TAC Paid\", 0))"
      },
      "Downpayment Paid": {
        "type": "double",
        "description": "Valor de entrada jÃ¡ pago",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Downpayment Paid\", 0))"
      },
      "Taxes Percent": {
        "type": "double",
        "description": "Percentual de impostos aplicados",
        "sensitive": false,
        "usage": "AVG(\"Taxes Percent\") para mÃ©dia de impostos"
      },
      "Installments Value": {
        "type": "double",
        "description": "Valor total das parcelas",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Installments Value\", 0))"
      },
      "Taxes Value Installments": {
        "type": "double",
        "description": "Valor dos impostos embutidos nas parcelas",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Taxes Value Installments\", 0))"
      },
      "Taxes Value Initial Payment": {
        "type": "double",
        "description": "Impostos embutidos no pagamento inicial",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Taxes Value Initial Payment\", 0))"
      },
      "Shipment Value": {
        "type": "double",
        "description": "Valor do frete",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Shipment Value\", 0))"
      },
      "Discount Value": {
        "type": "double",
        "description": "Valor total dos descontos aplicados",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Discount Value\", 0))"
      },
      "Total Installments": {
        "type": "double",
        "description": "NÃºmero total de parcelas",
        "sensitive": false,
        "usage": "AVG(\"Total Installments\") para mÃ©dia de parcelas"
      },
      "Dealer": {
        "type": "string",
        "description": "Revendedor associado ao pedido",
        "sensitive": false,
        "usage": "GROUP BY Dealer para anÃ¡lise por revendedor"
      },
      "Sellers": {
        "type": "string",
        "description": "Nome(s) dos vendedores que realizaram a venda",
        "sensitive": false,
        "usage": "GROUP BY Sellers para anÃ¡lise por vendedor"
      },
      "Coupons": {
        "type": "string",
        "description": "Cupons aplicados no pedido",
        "sensitive": false,
        "usage": "WHERE Coupons IS NOT NULL para pedidos com cupons"
      },
      "Delivery Date": {
        "type": "string (datetime)",
        "description": "Data de entrega do produto",
        "sensitive": false,
        "usage": "Filtros de data de entrega"
      },
      "Contract Start Date": {
        "type": "string (datetime)",
        "description": "Data de inÃ­cio do contrato",
        "sensitive": false,
        "usage": "PRINCIPAL para contabilizar vendas - usar em filtros temporais de vendas",
        "note": "Esta Ã© a coluna mais importante para anÃ¡lises de vendas"
      },
      "Status Default": {
        "type": "string",
        "description": "Status de inadimplÃªncia do cliente",
        "sensitive": false,
        "allowed_values": [
          "OK",
          "REGULAR",
          "N1",
          "N2",
          "N3",
          "N4",
          "N5",
          "N6",
          "N7"
        ],
        "usage": "WHERE \"Status Default\" IN ('N1', 'N2', 'N3', 'N4', 'N5', 'N6', 'N7') para inadimplentes"
      },
      "Customer Phone Number": {
        "type": "string",
        "description": "Telefone de contato do cliente",
        "sensitive": true,
        "security": "DADOS SENSÃVEIS - NUNCA RETORNAR"
      },
      "Serial Number": {
        "type": "string",
        "description": "NÃºmero de sÃ©rie do produto vendido",
        "sensitive": true,
        "security": "DADOS SENSÃVEIS - NUNCA RETORNAR"
      },
      "IMEI 1": {
        "type": "string",
        "description": "IMEI primÃ¡rio do dispositivo (caso seja um celular)",
        "sensitive": true,
        "security": "DADOS SENSÃVEIS - NUNCA RETORNAR"
      },
      "IMEI 2": {
        "type": "string",
        "description": "IMEI secundÃ¡rio do dispositivo (caso dual-chip)",
        "sensitive": true,
        "security": "DADOS SENSÃVEIS - NUNCA RETORNAR"
      },
      "Contract Total Value Expected": {
        "type": "double",
        "description": "Valor total esperado do contrato",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Contract Total Value Expected\", 0))"
      },
      "Installments Paid Value": {
        "type": "double",
        "description": "Valor total jÃ¡ pago em parcelas",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Installments Paid Value\", 0))"
      },
      "Order Total Paid": {
        "type": "double",
        "description": "Valor total jÃ¡ pago do pedido",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Order Total Paid\", 0)) - principal para total recebido"
      },
      "Remaining Total": {
        "type": "double",
        "description": "Saldo restante a pagar",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Remaining Total\", 0)) - principal para valores a receber"
      },
      "Total Delay": {
        "type": "double",
        "description": "Quantidade total de dias de atraso no pagamento",
        "sensitive": false,
        "usage": "AVG(\"Total Delay\") ou SUM(\"Total Delay\")"
      },
      "Total Extra Payment Value Paid": {
        "type": "double",
        "description": "Valor extra pago alÃ©m do esperado",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Total Extra Payment Value Paid\", 0))"
      },
      "Total Value Refunded": {
        "type": "double",
        "description": "Valor total reembolsado ao cliente",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Total Value Refunded\", 0))"
      },
      "Early Purchase Value": {
        "type": "double",
        "description": "Valor pago por antecipaÃ§Ã£o do contrato (quitaÃ§Ã£o antecipada)",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Early Purchase Value\", 0)) - principal para quitaÃ§Ãµes"
      },
      "Early Purchase Date": {
        "type": "string (datetime)",
        "description": "Data em que o cliente realizou a quitaÃ§Ã£o antecipada do contrato",
        "sensitive": false,
        "usage": "Filtros para anÃ¡lise de quitaÃ§Ãµes antecipadas"
      },
      "customer_income": {
        "type": "double",
        "description": "Renda mensal estimada do cliente",
        "sensitive": false,
        "usage": "AVG(customer_income) para mÃ©dia de renda"
      },
      "Cancelled At": {
        "type": "string (datetime)",
        "description": "Data de cancelamento do pedido/venda",
        "sensitive": false,
        "usage": "Filtros para anÃ¡lise de cancelamentos"
      },
      "Finished At": {
        "type": "string (datetime)",
        "description": "Data de finalizaÃ§Ã£o do pedido/venda",
        "sensitive": false,
        "usage": "Filtros para anÃ¡lise de finalizaÃ§Ãµes"
      },
      "PDD at": {
        "type": "string (datetime)",
        "description": "Data de PDD (Pending Documents)",
        "sensitive": false,
        "usage": "Filtros para anÃ¡lise de documentos pendentes"
      }
    }
  },
  "general_instructions": [
    "ðŸ”´ REGRA CRÃTICA: SEMPRE colocar TODAS as colunas entre aspas duplas - \"Status\", \"Order Code\", \"Customer Name\", etc",
    "ðŸ”´ NUNCA usar nome de coluna sem aspas duplas (Status âŒ â†’ \"Status\" âœ…)",
    "Usar exatamente os nomes das colunas conforme schema",
    "Para comparaÃ§Ãµes entre perÃ­odos, usar CROSS JOIN para compatibilidade Athena"
  ],
  "postgresql_syntax_rules": {
    "column_names": "SEMPRE usar aspas duplas em TODAS as colunas: \"Contract Start Date\", \"Status\", \"Order Code\", etc",
    "aliases": "Usar alias apÃ³s agregaÃ§Ãµes: COUNT(*) AS total",
    "date_parsing": "(TO_TIMESTAMP(TRIM(\"coluna\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date",
    "timezone": "America/New_York",
    "CRITICAL_COLUMN_QUOTING": [
      "SEMPRE usar aspas duplas em TODAS as referÃªncias a colunas",
      "Exemplos corretos: \"Status\", \"Order Code\", \"Customer Name\", \"Contract Start Date\"",
      "NUNCA usar: Status, Order Code, Customer Name (sem aspas)",
      "Isso evita erros como 'column status does not exist'"
    ],
    "CRITICAL_DATE_RULES": [
      "SEMPRE usar ::date para converter timestamp em data",
      "NUNCA usar CAST(TO_TIMESTAMP(...) AS TIMESTAMP)",
      "SEMPRE considerar timezone Miami (America/New_York)",
      "IMPORTANTE: A coluna 'Contract Start Date' JÃ ESTÃ armazenada em timezone de Miami, entÃ£o use AT TIME ZONE 'America/New_York' apÃ³s TO_TIMESTAMP para indicar isso",
      "Usar (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York') para horÃ¡rio Miami atual",
      "Para filtros temporais usar o mapeamento em portuguÃªs (hoje, ontem, esse mÃªs, etc)",
      "PADRÃƒO CORRETO: (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date"
    ],
    "null_handling": "Usar COALESCE(coluna, 0) em agregaÃ§Ãµes",
    "forbidden_functions": [
      {
        "funcao": "LAST_DAY",
        "variantes": [
          "last_day",
          "LAST_DAY(",
          "last_day(",
          "DAY(LAST_DAY",
          "day(last_day",
          "ontem"
        ],
        "motivo": "FunÃ§Ã£o nÃ£o existe no PostgreSQL 15",
        "alternativa_postgresql": "(DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month' - INTERVAL '1 day')::date"
      }
    ]
  },
  "semantic_rules": {
    "vendas": {
      "date_column": "Contract Start Date"
    },
    "temporal_mapping": {
      "hoje|hj": {
        "variantes": [
          "hoje",
          "hj",
          "today"
        ],
        "query": "(TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date = (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York')::date"
      },
      "ontem": {
        "variantes": [
          "ontem",
          "yesterday"
        ],
        "query": "(TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date = (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York' - INTERVAL '1 day')::date"
      },
      "esta_semana": {
        "variantes": [
          "esta semana",
          "essa semana",
          "semana atual",
          "this week"
        ],
        "query": "(TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date >= DATE_TRUNC('week', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York'))::date"
      },
      "este_mes": {
        "variantes": [
          "este mes",
          "esse mes",
          "este mÃªs",
          "esse mÃªs",
          "mes atual",
          "mÃªs atual",
          "this month"
        ],
        "query": "(TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date >= DATE_TRUNC('month', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York'))::date"
      },
      "mes_passado": {
        "variantes": [
          "mes passado",
          "mÃªs passado",
          "ultimo mes",
          "Ãºltimo mÃªs",
          "last month"
        ],
        "query": "(TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date >= (DATE_TRUNC('month', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York')) - INTERVAL '1 month')::date AND (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date < DATE_TRUNC('month', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York'))::date"
      },
      "este_ano": {
        "variantes": [
          "este ano",
          "esse ano",
          "ano atual",
          "this year"
        ],
        "query": "(TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date >= DATE_TRUNC('year', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York'))::date"
      },
      "ano_passado": {
        "variantes": [
          "ano passado",
          "ultimo ano",
          "Ãºltimo ano",
          "last year"
        ],
        "query": "(TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date >= (DATE_TRUNC('year', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York')) - INTERVAL '1 year')::date AND (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date < DATE_TRUNC('year', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York'))::date"
      }
    },
    "status_mapping": {
      "finalizados": "WHERE \"Status\" = 'FINISHED'",
      "cancelados": "WHERE \"Status\" = 'CANCELED'",
      "entregues": "WHERE \"Status\" = 'DELIVERED'",
      "fechados": "WHERE \"Status\" = 'CLOSED'",
      "negados": "WHERE \"Status\" = 'DENIED'",
      "em_transito": "WHERE \"Status\" = 'IN TRANSIT'",
      "aguardando_assinatura": "WHERE \"Status\" = 'WAITING SIGN'",
      "aguardando_analise": "WHERE \"Status\" = 'WAITING ANALISYS'",
      "aguardando_envio": "WHERE \"Status\" = 'WAITING SHIPMENT'",
      "pdd": "WHERE \"Status\" = 'PDD'",
      "fraude": "WHERE \"Status\" = 'FRAUD'",
      "fechados_fraude": "WHERE \"Status\" = 'CLOSED BY FRAUD'",
      "aprovados": "WHERE \"Status\" = 'APPROVED'",
      "abertos": "WHERE \"Status\" = 'OPEN'",
      "pagamento_pendente": "WHERE \"Status\" = 'PENDING PAYMENT'",
      "pagamento_parcial": "WHERE \"Status\" = 'PARTIAL PAYMENT'",
      "recuperacao_pdd": "WHERE \"Status\" = 'RECOVERY PDD'",
      "quitacoes": "WHERE \"Status\" = 'EARLY PURCHASE' OR \"Early Purchase Value\" > 0",
      "vendas_ativas": "WHERE \"Status\" IN ('IN TRANSIT', 'WAITING SHIPMENT', 'DELIVERED')"
    },
    "inadimplencia": {
      "inadimplentes": "WHERE \"Status Default\" IN ('N1', 'N2', 'N3', 'N4', 'N5', 'N6', 'N7')",
      "regulares": "WHERE \"Status Default\" = 'REGULAR'",
      "ok": "WHERE \"Status Default\" = 'OK'"
    },
    "valores": {
      "total_recebido": "SUM(\"Order Total Paid\")",
      "valores_vendidos": "SUM(\"Contract Total Value Expected\") WHERE \"Status\" IN ('DELIVERED', 'EARLY PURCHASE', 'FINISHED', 'IN TRANSIT', 'PDD', 'WAITING SHIPMENT')",
      "valores_a_receber": "SUM(COALESCE(\"Remaining Total\", 0)) WHERE \"Status\" IN ('DELIVERED', 'IN TRANSIT', 'WAITING SHIPMENT')",
      "valores_fraude_pdd": "SUM(COALESCE(\"Remaining Total\", 0)) WHERE \"Status\" IN ('FRAUD', 'PDD')",
      "valores_quitacao": "SUM(\"Early Purchase Value\")",
      "valores_deixados_arrecadar": "SUM(\"Contract Total Value Expected\" - \"Order Total Paid\") para quitaÃ§Ãµes antecipadas"
    },
    "contagens": {
      "pedidos": "COUNT(DISTINCT \"Order Code\")",
      "clientes_unicos": "COUNT(DISTINCT \"Customer Name\")",
      "vendas_geradas": "COUNT(*) WHERE \"Status\" NOT IN ('DENIED', 'OPEN', 'CLOSED', 'CLOSED BY FRAUD', 'WAITING ANALISYS', 'DELIVERY_CANCELLED', 'RECUSED', 'PENDING PAYMENT', 'PARTIAL PAYMENT', 'APPROVED')"
    }
  },
  "query_examples": [
    {
      "description": "Vendas hoje (Miami timezone)",
      "query": "SELECT COUNT(*) AS total FROM order_report WHERE (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date = (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York')::date"
    },
    {
      "description": "Vendas ontem (Miami timezone)",
      "query": "SELECT COUNT(*) AS total FROM order_report WHERE (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date = (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York' - INTERVAL '1 day')::date"
    },
    {
      "description": "Top 5 produtos mais vendidos",
      "query": "SELECT item_name, COUNT(*) AS total_vendas FROM order_report GROUP BY item_name ORDER BY total_vendas DESC LIMIT 5"
    },
    {
      "description": "Total recebido",
      "query": "SELECT SUM(COALESCE(\"Order Total Paid\", 0)) AS total_recebido FROM order_report"
    },
    {
      "description": "Inadimplentes",
      "query": "SELECT COUNT(*) AS total FROM order_report WHERE \"Status Default\" IN ('N1', 'N2', 'N3', 'N4', 'N5', 'N6', 'N7')"
    },
    {
      "description": "Vendas do mÃªs atual (Miami timezone)",
      "query": "SELECT COUNT(*) AS total FROM order_report WHERE (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date >= DATE_TRUNC('month', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York'))::date AND (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date < (DATE_TRUNC('month', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York')) + INTERVAL '1 month')::date"
    },
    {
      "description": "ComparaÃ§Ã£o mÃªs atual vs mÃªs passado (Miami timezone)",
      "query": "WITH mes_atual AS (SELECT COUNT(*) as total FROM order_report WHERE (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date >= DATE_TRUNC('month', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York'))::date AND (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date < (DATE_TRUNC('month', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York')) + INTERVAL '1 month')::date), mes_passado AS (SELECT COUNT(*) as total FROM order_report WHERE (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date >= (DATE_TRUNC('month', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York')) - INTERVAL '1 month')::date AND (TO_TIMESTAMP(TRIM(\"Contract Start Date\"), 'YYYY-MM-DD HH12:MI AM') AT TIME ZONE 'America/New_York')::date < DATE_TRUNC('month', (CURRENT_TIMESTAMP AT TIME ZONE 'America/New_York'))::date) SELECT ma.total as mes_atual, mp.total as mes_passado FROM mes_atual ma CROSS JOIN mes_passado mp"
    }
  ],
  "output_format": [
    "query_sql",
    "query_explanation",
    "columns_used",
    "filters_applied",
    "security_validated"
  ],
  "system_prompt_template": "VocÃª Ã© o Analysis Orchestrator Agent, motor principal de geraÃ§Ã£o de queries SQL para PostgreSQL 15.\n\nðŸŽ¯ OBJETIVO:\nTransformar um plano de anÃ¡lise em uma query SQL OTIMIZADA, SEGURA e VÃLIDA para PostgreSQL 15.\n\nðŸ”´ REGRA CRÃTICA OBRIGATÃ“RIA:\n- TODAS as colunas DEVEM estar entre aspas duplas\n- Exemplos CORRETOS: \"Status\", \"Order Code\", \"Customer Name\"\n- Exemplos ERRADOS: Status, Order Code, Customer Name (sem aspas)\n- Isso vale para SELECT, WHERE, GROUP BY, ORDER BY - TODAS as clÃ¡usulas\n\nðŸŽ¯ FORMATO DE SAÃDA (JSON):\n{{\n  \"query_sql\": \"Query SQL completa e otimizada\",\n  \"query_explanation\": \"ExplicaÃ§Ã£o clara do que a query faz\",\n  \"columns_used\": [\"lista\", \"de\", \"colunas\"],\n  \"filters_applied\": [\"lista\", \"de\", \"filtros\"],\n  \"optimization_notes\": \"Notas sobre otimizaÃ§Ãµes aplicadas\"\n}}",
  "user_prompt_template": "Transforme este plano em uma query SQL otimizada:\n\nðŸ“ PERGUNTA DO USUÃRIO:\n{pergunta}\n\nðŸ“‹ PLANO DE ANÃLISE:\n{plan}\n\nðŸ“‚ CATEGORIA: {intent_category}\n\nGere a query SQL seguindo TODAS as regras de seguranÃ§a, semÃ¢ntica e sintaxe do Athena.\nRetorne no formato JSON especificado."
}