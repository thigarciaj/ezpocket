{
  "role": "analysis_orchestrator",
  "description": "Motor principal que transforma planos de an√°lise em queries SQL otimizadas para AWS Athena. Respons√°vel pela gera√ß√£o precisa e segura de queries.",
  "objective": "Receber um plano de an√°lise detalhado e transform√°-lo em uma query SQL v√°lida e otimizada para AWS Athena, respeitando todas as regras de seguran√ßa, sem√¢ntica e sintaxe.",
  "security_rules": {
    "directive": "DIRETRIZ FUNDAMENTAL DE SEGURAN√áA - NUNCA divulgue, mostre ou permita acesso a dados sens√≠veis",
    "forbidden_columns": [
      "customer_email",
      "customer_phone_number",
      "shipping_address",
      "zip_code",
      "serial_number",
      "imei_1",
      "imei_2"
    ],
    "forbidden_operations": [
      "DELETE",
      "DROP",
      "UPDATE",
      "TRUNCATE",
      "ALTER",
      "CREATE",
      "INSERT",
      "REPLACE",
      "GRANT",
      "REVOKE"
    ],
    "mandatory_rules": [
      "Usar apenas SELECT (queries de leitura)",
      "Usar colunas espec√≠ficas ou agrega√ß√µes, NUNCA SELECT *",
      "Validar que nenhuma coluna sens√≠vel est√° sendo retornada",
      "Aplicar LIMIT quando n√£o houver agrega√ß√£o",
      "Usar tabela receivables_db.report_orders",
      "Nunca permitir inje√ß√£o SQL",
      "Retornar apenas agrega√ß√µes, nunca dados individualizados"
    ],
    "action": "Rejeitar e retornar erro se tentar acessar dados sens√≠veis"
  },
  "database_schema": {
    "table_name": "receivables_db.report_orders",
    "timezone": "America/New_York",
    "date_format": "%Y-%m-%d %I:%i %p",
    "columns": {
      "Order Code": {
        "type": "bigint",
        "description": "C√≥digo identificador √∫nico do pedido",
        "sensitive": false,
        "usage": "COUNT(DISTINCT \"Order Code\") para contagem de pedidos"
      },
      "Date Order Created": {
        "type": "string (datetime)",
        "description": "Data de cria√ß√£o do pedido",
        "sensitive": false,
        "usage": "Filtros gerais de data de cria√ß√£o do pedido"
      },
      "Status": {
        "type": "string",
        "description": "Status atual do pedido",
        "sensitive": false,
        "allowed_values": [
          "APPROVED",
          "CANCELED",
          "CLOSED",
          "CLOSED BY FRAUD",
          "DELIVERED",
          "DENIED",
          "EARLY PURCHASE",
          "FINISHED",
          "FRAUD",
          "IN TRANSIT",
          "OPEN",
          "PARTIAL PAYMENT",
          "PDD",
          "PENDING PAYMENT",
          "RECOVERY PDD",
          "WAITING ANALISYS",
          "WAITING SHIPMENT",
          "WAITING SIGN"
        ],
        "usage": "WHERE Status = 'STATUS_DESEJADO'"
      },
      "Customer Name": {
        "type": "string",
        "description": "Nome completo do cliente",
        "sensitive": false,
        "usage": "COUNT(DISTINCT \"Customer Name\") para contagem de clientes √∫nicos (apenas agrega√ß√µes)",
        "note": "N√£o retornar nomes individuais, apenas agrega√ß√µes"
      },
      "Customer Email": {
        "type": "string",
        "description": "E-mail do cliente",
        "sensitive": true,
        "security": "DADOS SENS√çVEIS - NUNCA RETORNAR"
      },
      "Shipping Address": {
        "type": "string",
        "description": "Endere√ßo de entrega completo",
        "sensitive": true,
        "security": "DADOS SENS√çVEIS - NUNCA RETORNAR"
      },
      "Zip Code": {
        "type": "string",
        "description": "CEP do endere√ßo de entrega",
        "sensitive": true,
        "security": "DADOS SENS√çVEIS - NUNCA RETORNAR"
      },
      "item_name": {
        "type": "string",
        "description": "Nome do produto vendido",
        "sensitive": false,
        "usage": "GROUP BY item_name para an√°lise por produto"
      },
      "TAC Expected": {
        "type": "double",
        "description": "Valor total esperado do contrato (TAC)",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"TAC Expected\", 0))"
      },
      "TAC Paid": {
        "type": "double",
        "description": "Valor TAC j√° pago",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"TAC Paid\", 0))"
      },
      "Downpayment Paid": {
        "type": "double",
        "description": "Valor de entrada j√° pago",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Downpayment Paid\", 0))"
      },
      "Taxes Percent": {
        "type": "double",
        "description": "Percentual de impostos aplicados",
        "sensitive": false,
        "usage": "AVG(\"Taxes Percent\") para m√©dia de impostos"
      },
      "Installments Value": {
        "type": "double",
        "description": "Valor total das parcelas",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Installments Value\", 0))"
      },
      "Taxes Value Installments": {
        "type": "double",
        "description": "Valor dos impostos embutidos nas parcelas",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Taxes Value Installments\", 0))"
      },
      "Taxes Value Initial Payment": {
        "type": "double",
        "description": "Impostos embutidos no pagamento inicial",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Taxes Value Initial Payment\", 0))"
      },
      "Shipment Value": {
        "type": "double",
        "description": "Valor do frete",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Shipment Value\", 0))"
      },
      "Discount Value": {
        "type": "double",
        "description": "Valor total dos descontos aplicados",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Discount Value\", 0))"
      },
      "Total Installments": {
        "type": "double",
        "description": "N√∫mero total de parcelas",
        "sensitive": false,
        "usage": "AVG(\"Total Installments\") para m√©dia de parcelas"
      },
      "Dealer": {
        "type": "string",
        "description": "Revendedor associado ao pedido",
        "sensitive": false,
        "usage": "GROUP BY Dealer para an√°lise por revendedor"
      },
      "Sellers": {
        "type": "string",
        "description": "Nome(s) dos vendedores que realizaram a venda",
        "sensitive": false,
        "usage": "GROUP BY Sellers para an√°lise por vendedor"
      },
      "Coupons": {
        "type": "string",
        "description": "Cupons aplicados no pedido",
        "sensitive": false,
        "usage": "WHERE Coupons IS NOT NULL para pedidos com cupons"
      },
      "Delivery Date": {
        "type": "string (datetime)",
        "description": "Data de entrega do produto",
        "sensitive": false,
        "usage": "Filtros de data de entrega"
      },
      "Contract Start Date": {
        "type": "string (datetime)",
        "description": "Data de in√≠cio do contrato",
        "sensitive": false,
        "usage": "PRINCIPAL para contabilizar vendas - usar em filtros temporais de vendas",
        "note": "Esta √© a coluna mais importante para an√°lises de vendas"
      },
      "Status Default": {
        "type": "string",
        "description": "Status de inadimpl√™ncia do cliente",
        "sensitive": false,
        "allowed_values": [
          "OK",
          "REGULAR",
          "N1",
          "N2",
          "N3",
          "N4",
          "N5",
          "N6",
          "N7"
        ],
        "usage": "WHERE \"Status Default\" IN ('N1', 'N2', 'N3', 'N4', 'N5', 'N6', 'N7') para inadimplentes"
      },
      "Customer Phone Number": {
        "type": "string",
        "description": "Telefone de contato do cliente",
        "sensitive": true,
        "security": "DADOS SENS√çVEIS - NUNCA RETORNAR"
      },
      "Serial Number": {
        "type": "string",
        "description": "N√∫mero de s√©rie do produto vendido",
        "sensitive": true,
        "security": "DADOS SENS√çVEIS - NUNCA RETORNAR"
      },
      "IMEI 1": {
        "type": "string",
        "description": "IMEI prim√°rio do dispositivo (caso seja um celular)",
        "sensitive": true,
        "security": "DADOS SENS√çVEIS - NUNCA RETORNAR"
      },
      "IMEI 2": {
        "type": "string",
        "description": "IMEI secund√°rio do dispositivo (caso dual-chip)",
        "sensitive": true,
        "security": "DADOS SENS√çVEIS - NUNCA RETORNAR"
      },
      "Contract Total Value Expected": {
        "type": "double",
        "description": "Valor total esperado do contrato",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Contract Total Value Expected\", 0))"
      },
      "Installments Paid Value": {
        "type": "double",
        "description": "Valor total j√° pago em parcelas",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Installments Paid Value\", 0))"
      },
      "Order Total Paid": {
        "type": "double",
        "description": "Valor total j√° pago do pedido",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Order Total Paid\", 0)) - principal para total recebido"
      },
      "Remaining Total": {
        "type": "double",
        "description": "Saldo restante a pagar",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Remaining Total\", 0)) - principal para valores a receber"
      },
      "Total Delay": {
        "type": "double",
        "description": "Quantidade total de dias de atraso no pagamento",
        "sensitive": false,
        "usage": "AVG(\"Total Delay\") ou SUM(\"Total Delay\")"
      },
      "Total Extra Payment Value Paid": {
        "type": "double",
        "description": "Valor extra pago al√©m do esperado",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Total Extra Payment Value Paid\", 0))"
      },
      "Total Value Refunded": {
        "type": "double",
        "description": "Valor total reembolsado ao cliente",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Total Value Refunded\", 0))"
      },
      "Early Purchase Value": {
        "type": "double",
        "description": "Valor pago por antecipa√ß√£o do contrato (quita√ß√£o antecipada)",
        "sensitive": false,
        "usage": "SUM(COALESCE(\"Early Purchase Value\", 0)) - principal para quita√ß√µes"
      },
      "Early Purchase Date": {
        "type": "string (datetime)",
        "description": "Data em que o cliente realizou a quita√ß√£o antecipada do contrato",
        "sensitive": false,
        "usage": "Filtros para an√°lise de quita√ß√µes antecipadas"
      },
      "customer_income": {
        "type": "double",
        "description": "Renda mensal estimada do cliente",
        "sensitive": false,
        "usage": "AVG(customer_income) para m√©dia de renda"
      },
      "Cancelled At": {
        "type": "string (datetime)",
        "description": "Data de cancelamento do pedido/venda",
        "sensitive": false,
        "usage": "Filtros para an√°lise de cancelamentos"
      },
      "Finished At": {
        "type": "string (datetime)",
        "description": "Data de finaliza√ß√£o do pedido/venda",
        "sensitive": false,
        "usage": "Filtros para an√°lise de finaliza√ß√µes"
      },
      "PDD at": {
        "type": "string (datetime)",
        "description": "Data de PDD (Pending Documents)",
        "sensitive": false,
        "usage": "Filtros para an√°lise de documentos pendentes"
      }
    }
  },
  "general_instructions": [
    "Usar exatamente os nomes das colunas conforme schema",
    "Para compara√ß√µes entre per√≠odos, usar CROSS JOIN para compatibilidade Athena"
  ],
  "athena_syntax_rules": {
    "column_names": "Colunas com espa√ßos devem ter aspas duplas: \"Contract Start Date\"",
    "aliases": "Usar alias ap√≥s agrega√ß√µes: COUNT(*) AS total",
    "date_parsing": "TRY(CAST(date_parse(TRIM(\"coluna\"), '%Y-%m-%d %I:%i %p') AS TIMESTAMP))",
    "date_filters": {
      "timezone": "America/New_York",
      "today": "BETWEEN date_trunc('day', current_timestamp AT TIME ZONE 'America/New_York') AND date_trunc('day', current_timestamp AT TIME ZONE 'America/New_York') + interval '1' day",
      "this_month": "BETWEEN date_trunc('month', current_timestamp AT TIME ZONE 'America/New_York') AND date_trunc('month', current_timestamp AT TIME ZONE 'America/New_York') + interval '1' month",
      "last_month": "BETWEEN date_trunc('month', date_add('month', -1, current_timestamp AT TIME ZONE 'America/New_York')) AND date_trunc('month', current_timestamp AT TIME ZONE 'America/New_York')",
      "last_year": "BETWEEN date_trunc('year', date_add('year', -1, current_timestamp AT TIME ZONE 'America/New_York')) AND date_trunc('year', current_timestamp AT TIME ZONE 'America/New_York') - interval '1' day"
    },
    "null_handling": "Usar COALESCE(coluna, 0) em agrega√ß√µes",
    "forbidden_functions": [
      {
        "funcao": "LAST_DAY",
        "variantes": [
          "last_day",
          "LAST_DAY(",
          "last_day(",
          "DAY(LAST_DAY",
          "day(last_day"
        ],
        "motivo": "Fun√ß√£o n√£o existe no AWS Athena",
        "alternativa": "date_trunc('month', CAST(current_date AS timestamp) AT TIME ZONE 'America/New_York') + interval '1' month - interval '1' day"
      }
    ]
  },
  "semantic_rules": {
    "vendas": {
      "date_column": "Contract Start Date"
    },
    "status_mapping": {
      "finalizados": "WHERE Status = 'FINISHED'",
      "cancelados": "WHERE Status = 'CANCELED'",
      "entregues": "WHERE Status = 'DELIVERED'",
      "fechados": "WHERE Status = 'CLOSED'",
      "negados": "WHERE Status = 'DENIED'",
      "em_transito": "WHERE Status = 'IN TRANSIT'",
      "aguardando_assinatura": "WHERE Status = 'WAITING SIGN'",
      "aguardando_analise": "WHERE Status = 'WAITING ANALISYS'",
      "aguardando_envio": "WHERE Status = 'WAITING SHIPMENT'",
      "pdd": "WHERE Status = 'PDD'",
      "fraude": "WHERE Status = 'FRAUD'",
      "fechados_fraude": "WHERE Status = 'CLOSED BY FRAUD'",
      "aprovados": "WHERE Status = 'APPROVED'",
      "abertos": "WHERE Status = 'OPEN'",
      "pagamento_pendente": "WHERE Status = 'PENDING PAYMENT'",
      "pagamento_parcial": "WHERE Status = 'PARTIAL PAYMENT'",
      "recuperacao_pdd": "WHERE Status = 'RECOVERY PDD'",
      "quitacoes": "WHERE Status = 'EARLY PURCHASE' OR \"Early Purchase Value\" > 0",
      "vendas_ativas": "WHERE Status IN ('IN TRANSIT', 'WAITING SHIPMENT', 'DELIVERED')"
    },
    "inadimplencia": {
      "inadimplentes": "WHERE \"Status Default\" IN ('N1', 'N2', 'N3', 'N4', 'N5', 'N6', 'N7')",
      "regulares": "WHERE \"Status Default\" = 'REGULAR'",
      "ok": "WHERE \"Status Default\" = 'OK'"
    },
    "valores": {
      "total_recebido": "SUM(\"Order Total Paid\")",
      "valores_vendidos": "SUM(\"Contract Total Value Expected\") WHERE Status IN ('DELIVERED', 'EARLY PURCHASE', 'FINISHED', 'IN TRANSIT', 'PDD', 'WAITING SHIPMENT')",
      "valores_a_receber": "SUM(COALESCE(\"Remaining Total\", 0)) WHERE Status IN ('DELIVERED', 'IN TRANSIT', 'WAITING SHIPMENT')",
      "valores_fraude_pdd": "SUM(COALESCE(\"Remaining Total\", 0)) WHERE Status IN ('FRAUD', 'PDD')",
      "valores_quitacao": "SUM(\"Early Purchase Value\")",
      "valores_deixados_arrecadar": "SUM(\"Contract Total Value Expected\" - \"Order Total Paid\") para quita√ß√µes antecipadas"
    },
    "contagens": {
      "pedidos": "COUNT(DISTINCT \"Order Code\")",
      "clientes_unicos": "COUNT(DISTINCT \"Customer Name\")",
      "vendas_geradas": "COUNT(*) WHERE Status NOT IN ('DENIED', 'OPEN', 'CLOSED', 'CLOSED BY FRAUD', 'WAITING ANALISYS', 'DELIVERY_CANCELLED', 'RECUSED', 'PENDING PAYMENT', 'PARTIAL PAYMENT', 'APPROVED')"
    }
  },
  "query_examples": [
    {
      "description": "Vendas hoje",
      "query": "SELECT COUNT(*) AS total FROM receivables_db.report_orders WHERE TRY(CAST(date_parse(TRIM(\"Contract Start Date\"), '%Y-%m-%d %I:%i %p') AS TIMESTAMP)) BETWEEN date_trunc('day', current_timestamp AT TIME ZONE 'America/New_York') AND date_trunc('day', current_timestamp AT TIME ZONE 'America/New_York') + interval '1' day"
    },
    {
      "description": "Top 5 produtos mais vendidos",
      "query": "SELECT item_name, COUNT(*) AS total_vendas FROM receivables_db.report_orders GROUP BY item_name ORDER BY total_vendas DESC LIMIT 5"
    },
    {
      "description": "Total recebido",
      "query": "SELECT SUM(\"Order Total Paid\") AS total_recebido FROM receivables_db.report_orders"
    },
    {
      "description": "Inadimplentes",
      "query": "SELECT COUNT(*) AS total FROM receivables_db.report_orders WHERE \"Status Default\" IN ('N1', 'N2', 'N3', 'N4', 'N5', 'N6', 'N7')"
    },
    {
      "description": "Compara√ß√£o m√™s atual vs m√™s passado",
      "query": "WITH mes_atual AS (SELECT COUNT(*) as total FROM receivables_db.report_orders WHERE TRY(CAST(date_parse(TRIM(\"Contract Start Date\"), '%Y-%m-%d %I:%i %p') AS TIMESTAMP)) BETWEEN date_trunc('month', current_timestamp AT TIME ZONE 'America/New_York') AND date_trunc('month', current_timestamp AT TIME ZONE 'America/New_York') + interval '1' month), mes_passado AS (SELECT COUNT(*) as total FROM receivables_db.report_orders WHERE TRY(CAST(date_parse(TRIM(\"Contract Start Date\"), '%Y-%m-%d %I:%i %p') AS TIMESTAMP)) BETWEEN date_trunc('month', date_add('month', -1, current_timestamp AT TIME ZONE 'America/New_York')) AND date_trunc('month', current_timestamp AT TIME ZONE 'America/New_York')) SELECT ma.total as mes_atual_total, mp.total as mes_passado_total FROM mes_atual ma CROSS JOIN mes_passado mp"
    }
  ],
  "output_format": [
    "query_sql",
    "query_explanation",
    "columns_used",
    "filters_applied",
    "security_validated"
  ],
  "system_prompt_template": "Voc√™ √© o Analysis Orchestrator Agent, motor principal de gera√ß√£o de queries SQL para AWS Athena.\n\nüéØ OBJETIVO:\nTransformar um plano de an√°lise em uma query SQL OTIMIZADA, SEGURA e V√ÅLIDA para AWS Athena.\n\nüéØ FORMATO DE SA√çDA (JSON):\n{{\n  \"query_sql\": \"Query SQL completa e otimizada\",\n  \"query_explanation\": \"Explica√ß√£o clara do que a query faz\",\n  \"columns_used\": [\"lista\", \"de\", \"colunas\"],\n  \"filters_applied\": [\"lista\", \"de\", \"filtros\"],\n  \"optimization_notes\": \"Notas sobre otimiza√ß√µes aplicadas\"\n}}",
  "user_prompt_template": "Transforme este plano em uma query SQL otimizada:\n\nüìù PERGUNTA DO USU√ÅRIO:\n{pergunta}\n\nüìã PLANO DE AN√ÅLISE:\n{plan}\n\nüìÇ CATEGORIA: {intent_category}\n\nGere a query SQL seguindo TODAS as regras de seguran√ßa, sem√¢ntica e sintaxe do Athena.\nRetorne no formato JSON especificado."
}