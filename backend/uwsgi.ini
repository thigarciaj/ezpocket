[uwsgi]
# Início da configuração do uWSGI

# === Aplicação ===
# nome do arquivo e da aplicação Flask/FastAPI (main.py → app)
module = main:app

# muda o diretório de trabalho para onde está o app
chdir = /home/servidores/ezpocket/EZPOKET/backend

# caminho da venv Python usada pelo uWSGI
virtualenv = /home/servidores/ezpocket/EZPOKET/ezinho_assistente


# === Modo master e processos ===
# ativa o modo master (necessário para gerenciar workers)
master = true

# define 1 processo (ideal para CPU com 1 núcleo)
processes = 1

# cada processo terá 2 threads — ajuda em tarefas de I/O
threads = 2

# permite que as threads Python funcionem (importante para libs async)
enable-threads = true

# evita disputa de socket entre processos (melhora estabilidade)
thunder-lock = true

# carrega o app em cada worker separadamente (melhor para isolamento)
lazy-apps = true

# força um único interpretador Python por processo (mais seguro e leve)
single-interpreter = true

# === Comunicação HTTP (via Nginx) ===
# uWSGI escuta localmente (Nginx faz proxy para essa porta)
http = 0.0.0.0:8000

# até 128 conexões simultâneas em espera (padrão estável)
listen = 128

# remove arquivos temporários e sockets ao encerrar (limpa o ambiente)
vacuum = true

# === Segurança ===
# executa o uWSGI com o usuário "servidores" (evita rodar como root)
uid = servidores

# usa o grupo "servidores"
gid = servidores

# define permissões de socket (leitura/gravação apenas para dono e grupo)
chmod-socket = 660

# mata processos "órfãos" automaticamente ao reiniciar ou parar
no-orphans = true


# === Integração com PM2 ===
# encerra corretamente quando o PM2 manda um sinal de parada
die-on-term = true

# falha imediatamente se alguma config estiver errada
strict = true


# === Logs (gerenciados pelo PM2) ===
# mantém logging ativo (PM2 captura stdout/stderr)
disable-logging = false

# adiciona data/hora em cada linha de log
log-date = true
